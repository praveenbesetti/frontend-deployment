name: Deploy React Frontend to S3 + CloudFront

on:
  push:
    branches:
      - develop  # adjust if your frontend branch is different

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          # Use a stable Node version (18 or 20 are current recommendations)
          node-version: '18'

      # Install dependencies and explicitly fix the known build conflict
      - name: Install dependencies and address build issues
        run: |
          # 1. Install all dependencies normally
          npm install

          # 2. Fix the common 'validateOptions' error by forcing a compatible webpack version.
          # This overrides the version nested inside react-scripts and usually fixes the build error.
          npm install --save-dev --force webpack@^5.0.0
          
          # Optional alternative fix (uncomment if the above fails):
          # npm install --save-dev --force react-scripts@5.0.0

      # Create .env file from GitHub Secrets
      - name: Create .env file from GitHub Secrets
        run: |
          echo "REACT_APP_SECRET_KEY=${{ secrets.REACT_APP_DEV }}" >> .env

      # Build React app
      # The CI: false environment variable prevents react-scripts from treating warnings as errors
      - name: Build React app
        run: npm run build
        env:
          CI: false

      # Configure AWS credentials for subsequent steps
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1  # IMPORTANT: change to your S3 bucketâ€™s region

      # Sync build output to S3
      - name: Sync build to S3
        run: |
          aws s3 sync build/ s3://${{ secrets.S3_DEV_BUCKET }} --delete

      # Invalidate CloudFront cache to serve the new files immediately
      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID_DEV }} \
            --paths "/*"
